# IOC-Golang：一款 GO 语言依赖注入框架

```
  ___    ___     ____            ____           _                         
 |_ _|  / _ \   / ___|          / ___|   ___   | |   __ _   _ __     __ _ 
  | |  | | | | | |      _____  | |  _   / _ \  | |  / _` | | '_ \   / _` |
  | |  | |_| | | |___  |_____| | |_| | | (_) | | | | (_| | | | | | | (_| |
 |___|  \___/   \____|          \____|  \___/  |_|  \__,_| |_| |_|  \__, |
                                                                    |___/ 
```

[![IOC-Golang CI](https://github.com/alibaba/IOC-Golang/actions/workflows/github-actions.yml/badge.svg)](https://github.com/alibaba/IOC-Golang/actions/workflows/github-actions.yml)
[![License](https://img.shields.io/badge/license-Apache%202-4EB1BA.svg)](https://www.apache.org/licenses/LICENSE-2.0.html)

[文档](https://ioc-golang.github.io/cn)

[English Docs](https://ioc-golang.github.io)

[English README](./README.md)

![demo gif](https://raw.githubusercontent.com/ioc-golang/ioc-golang-website/main/resources/video/ioc-golang-demo.gif)

IOC-Golang 是一款强大的 Go 语言依赖注入框架，提供了一套完善的 IoC 容器。其能力如下：

- [依赖注入](https://ioc-golang.github.io/cn/docs/getting-started/tutorial/)

  支持任何结构、接口的依赖注入。

- 完善的对象生命周期管理机制。

  可以接管对象的创建、参数注入、工厂方法。可定制化对象参数来源。

- [代码调试能力](https://ioc-golang.github.io/cn/docs/examples/debug/)

  基于 AOP 的思路，为由框架接管的对象方法提供运行时监控、调试能力。

- [结构注册代码生成能力](https://ioc-golang.github.io/cn/docs/reference/iocli/#%E7%BB%93%E6%9E%84%E6%B3%A8%E8%A7%A3)

  我们提供了代码生成工具，开发者可以通过注解的方式标注结构，从而便捷地生成结构注册代码。

- [可扩展能力](https://ioc-golang.github.io/cn/docs/contribution-guidelines/)

  支持被注入结构的扩展、自动装载模型的扩展、调试 AOP 层的扩展。

- [完备的预制组件](https://ioc-golang.github.io/cn/docs/examples/)

  提供覆盖主流中间件的预制对象，方便直接注入使用。


## 项目结构

- **autowire：** 提供依赖注入内核，以及单例模型、多例模型两种基本自动装载模型
- **config：** 配置加载模块，负责解析 yaml 格式的配置文件
- **debug：** 调试模块：提供调试 API、提供调试注入层实现
- **extension：** 组件扩展目录：提供基于多种注入模型的预置实现结构：

    - autowire：自动装载模型扩展

        - grpc：grpc 客户端模型

        - config：配置模型

        - rpc：远程过程调用模型
    - config：配置注入模型扩展结构

        - string,int,map,slice
    - normal：多例模型扩展结构

        - redis

        - http_server
        - mysql

        - rocketmq

        - nacos
- **example：** 示例仓库
- **iocli：** 代码生成/程序调试 工具


## 快速开始

### 安装代码生成工具

```shell
go install github.com/alibaba/ioc-golang/iocli@latest
```

### 依赖注入教程

我们将开发一个具有以下拓扑的工程，在本例子中，可以展示

1. 注册代码生成
2. 接口注入
3. 对象指针注入
4. API 获取对象
5. 调试能力，查看运行中的接口、实现、方法；以及实时监听参数值、返回值。

![ioc-golang-quickstart-structure](https://raw.githubusercontent.com/ioc-golang/ioc-golang-website/main/resources/img/ioc-golang-quickstart-structure.png)


用户所需编写的全部代码：main.go

```go
package main

import (
	"fmt"
	"time"

	"github.com/alibaba/ioc-golang"
	"github.com/alibaba/ioc-golang/autowire/singleton"
)

// +ioc:autowire=true
// +ioc:autowire:type=singleton

type App struct {
	ServiceImpl1 Service `singleton:"main.ServiceImpl1"` // 要求注入Service 的 ServiceImpl1 实现
	ServiceImpl2 Service `singleton:"main.ServiceImpl2"` // 要求注入Service 的 ServiceImpl2 实现
	ServiceStruct *ServiceStruct `singleton:""` // 要求注入 ServiceStruct 指针
}

func (a*App) Run(){
	for {
		time.Sleep(time.Second*3)
		a.ServiceImpl1.Hello()
		a.ServiceImpl2.Hello()
		
		fmt.Println(a.ServiceStruct.GetString("laurence"))
    }
}


type Service interface{
	Hello()
}

// +ioc:autowire=true
// +ioc:autowire:type=singleton

type ServiceImpl1 struct {

}

func (s *ServiceImpl1) Hello(){
	fmt.Println("This is ServiceImpl1, hello world")
}

// +ioc:autowire=true
// +ioc:autowire:type=singleton

type ServiceImpl2 struct {

}

func (s *ServiceImpl2) Hello(){
	fmt.Println("This is ServiceImpl2, hello world")
}

// +ioc:autowire=true
// +ioc:autowire:type=singleton

type ServiceStruct struct {

}

func (s *ServiceStruct) GetString(name string)string{
	return fmt.Sprintf("Hello %s", name)
}

func main(){
	// 框架启动
	if err := ioc.Load(); err != nil{
		panic(err)
	}

	// 可通过这一 ID 获取实例: "包名.结构名"
	appInterface, err := singleton.GetImpl("main.App")
	if err != nil{
		panic(err)
	}
	app := appInterface.(*App)
	app.Run()
}
```

编写完毕后，当前目录执行以下命令，初始化 go mod ，生成结构注册代码。（mac 环境可能因权限原因需要sudo）：

```bash
% go mod init ioc-golang-demo
% go mod tidy
% sudo iocli gen
```

会在当前目录生成：zz_generated.ioc.go，开发者无需关心这一文件，该文件包含了所有接口的描述信息，

```go
//go:build !ignore_autogenerated
// +build !ignore_autogenerated

// Code generated by iocli

package main

import (
	autowire "github.com/alibaba/ioc-golang/autowire"
	"github.com/alibaba/ioc-golang/autowire/singleton"
)

func init() {
	singleton.RegisterStructDescriptor(&autowire.StructDescriptor{
		Factory: func() interface{} {
			return &App{}
		},
	})
	singleton.RegisterStructDescriptor(&autowire.StructDescriptor{
		Factory: func() interface{} {
			return &ServiceImpl1{}
		},
	})
	singleton.RegisterStructDescriptor(&autowire.StructDescriptor{
		Factory: func() interface{} {
			return &ServiceImpl2{}
		},
	})
	singleton.RegisterStructDescriptor(&autowire.StructDescriptor{
		Factory: func() interface{} {
			return &ServiceStruct{}
		},
	})
}

```

查看当前目录文件

```bash
% tree
.
├── go.mod
├── go.sum
├── main.go
└── zz_generated.ioc.go
```

#### 执行程序

**正常方式启动程序**

`go run .`

控制台打印输出：

```sh
  ___    ___     ____            ____           _                         
 |_ _|  / _ \   / ___|          / ___|   ___   | |   __ _   _ __     __ _ 
  | |  | | | | | |      _____  | |  _   / _ \  | |  / _` | | '_ \   / _` |
  | |  | |_| | | |___  |_____| | |_| | | (_) | | | | (_| | | | | | | (_| |
 |___|  \___/   \____|          \____|  \___/  |_|  \__,_| |_| |_|  \__, |
                                                                    |___/ 
Welcome to use ioc-golang!
[Boot] Start to load ioc-golang config
[Config] Load default config file from ../conf/ioc_golang.yaml
[Config] Load ioc-golang config file failed. open alibaba/IOC-Golang/example/conf/ioc_golang.yaml: no such file or directory
 The load procedure is continue
[Boot] Start to load debug
[Debug] Debug mod is not enabled
[Boot] Start to load autowire
[Autowire Type] Found registered autowire type singleton
[Autowire Struct Descriptor] Found type singleton registered SD main.App
[Autowire Struct Descriptor] Found type singleton registered SD main.ServiceImpl1
[Autowire Struct Descriptor] Found type singleton registered SD main.ServiceImpl2
[Autowire Struct Descriptor] Found type singleton registered SD main.ServiceStruct
This is ServiceImpl1, hello world
This is ServiceImpl2, hello world
Hello laurence
...
```

可看到，注入成功，程序正常运行。

**以调试模式启动程序**

`GOARCH=amd64 go run -gcflags="-N -l" -tags iocdebug .`

可看到打印出的日志中包含

```bash
[Debug] Debug server listening at :1999
```

查看所有结构和方法

```bash
% iocli list
main.App
[Run]

main.ServiceImpl1
[Hello]

main.ServiceImpl2
[Hello]

main.ServiceStruct
[GetString]

```

监听方法的参数和返回值。以监听 GetString 方法为例，每隔三秒钟函数被调用的时候，打印参数和返回值。

```bash
% iocli watch main.ServiceStruct GetString

========== On Call ==========
main.ServiceStruct.GetString()
Param 1: (string) (len=8) "laurence"


========== On Response ==========
main.ServiceStruct.GetString()
Response 1: (string) (len=14) "Hello laurence"
...
```



### 注解分析

```go
// +ioc:autowire=true
代码生成工具会识别到标有 +ioc:autowire=true 注解的对象

// +ioc:autowire:type=singleton
标记注入模型为 singleton 单例模型，还有 normal 多例模型等扩展

```

###  更多

更多代码生成注解可以移步[ioc-golang-cli](https://github.com/alibaba/IOC-Golang/tree/master/iocli).查看。

可以移步 [ioc-golang-example](https://github.com/alibaba/IOC-Golang/tree/master/example)  查看更多例子和高级使用方法。


### 证书

IOC-Golang developed by Alibaba and licensed under the Apache License (Version 2.0).
See the NOTICE file for more information.